# yaml-language-server: $schema=https://raw.githubusercontent.com/flanksource/duty/main/schema/openapi/view.schema.json
{{- if and .Values.views.enabled .Values.views.recentChanges.enabled}}
apiVersion: mission-control.flanksource.com/v1
kind: View
metadata:
  name: recent-changes
  labels:
    {{- include "mission-control.labels" . | nindent 4 }}
spec:
  display:
    title: Recent Changes
    icon: warning
    {{- if .Values.views.recentChanges.sidebar }}
    sidebar: true
    {{- end }}
  panels:
    - name: Recent Changes
      type: number
      description: Last 24 hours
      query: SELECT count as value FROM changes_count_last_24h
    - name: By Severity
      description: Recent Changes grouped by severity
      type: piechart
      piechart:
        colors:
          unhealthy: "#F04E6E"
          warning: "#F4B23C"
      query: SELECT COUNT(*) AS count, severity FROM recent_changes GROUP BY severity
    - name: By Type
      description: Recent Changes grouped by type
      type: piechart
      query: SELECT COUNT(*) AS count, change_type AS type FROM recent_changes GROUP BY change_type
  columns:
    - name: change_id
      type: string
      hidden: true
      primaryKey: true
    - name: last_seen
      type: datetime
    - name: config_type
      type: string
      hidden: true
      filter:
        type: multiselect
    - name: catalog
      type: config_item
    - name: type
      type: string
      icon: row.type
      filter:
        type: multiselect
    - name: summary
      type: string
    - name: severity
      type: string
      filter:
        type: multiselect
      hidden: true
    - name: tags
      type: labels
      filter:
        type: multiselect
    - name: created_by
      type: string
  merge: >
    SELECT 
      id as change_id,
      config_id as id,
      name as catalog,
      type as config_type,
      change_type as type,
      severity,
      summary,
      tags,
      created_at AS last_seen,
      source as created_by
    FROM recent_changes
  queries:
    changes_count_last_24h:
      columns:
        count: integer
      sql:
        connection: "connection://{{.Release.Namespace}}/{{ .Values.connectionName }}"
        query: SELECT COUNT(*) AS count FROM config_changes WHERE NOW() - created_at <= INTERVAL '24 hours';
    recent_changes:
      changes:
        name: "*"
        limit: 10 # TODO: This should be higher but we need to implement table page size in view spec first
        search: "severity!=info change_type!=diff @order=-created_at"
{{- end}}