{{- if .Values.canary.enabled }}
apiVersion: canaries.flanksource.com/v1
kind: Canary
metadata:
  name: {{ .Values.canary.name | default "argocd-health" }}
  labels:
    {{- include "argocd.labels" . | nindent 4 }}
spec:
  schedule: {{ .Values.canary.schedule | quote }}
  http:
    {{- if .Values.canary.repositories.enabled }}
    - name: argocd-repositories
      url: {{ printf "%s/api/v1/repositories?forceRefresh=true" (trimSuffix "/" .Values.canary.url) }}
      headers:
        - name: Authorization
          {{- if .Values.canary.token.valueFrom }}
          valueFrom:
            {{- .Values.canary.token.valueFrom | toYaml | nindent 12 }}
          {{- else }}
          value: {{ .Values.canary.token.value | quote }}
          {{- end }}
      responseCodes: [200]
      transformDeleteStrategy: OnTransformMarkHealthy
      transform:
        expr: |
          has(json.items) && json.items != null ?
            json.items.map(r, {
              'name': 'argocd-repo/' + r.repo,
              'icon': 'git',
              'pass': r.connectionState.status == 'Successful',
              'message': r.connectionState.status == 'Successful'
                ? r.repo + ' is healthy'
                : r.repo + ' connection failed: ' + r.connectionState.message,
              'labels': {
                'repo': r.repo,
                'status': r.connectionState.status
              }
            }).toJSON()
          : [].toJSON()
    {{- end }}

    {{- if .Values.canary.clusters.enabled }}
    - name: argocd-clusters
      url: {{ printf "%s/api/v1/clusters" (trimSuffix "/" .Values.canary.url) }}
      headers:
        - name: Authorization
          {{- if .Values.canary.token.valueFrom }}
          valueFrom:
            {{- .Values.canary.token.valueFrom | toYaml | nindent 12 }}
          {{- else }}
          value: {{ .Values.canary.token.value | quote }}
          {{- end }}
      responseCodes: [200]
      transformDeleteStrategy: OnTransformMarkHealthy
      transform:
        expr: |
          has(json.items) && json.items != null ?
            json.items.map(c, {
              'name': 'argocd-cluster/' + c.name,
              'icon': 'kubernetes',
              'pass': c.connectionState.status == 'Successful',
              'message': c.connectionState.status == 'Successful'
                ? c.name + ' (' + c.server + ') is healthy'
                : c.name + ' (' + c.server + ') connection failed: ' + c.connectionState.message,
              'labels': {
                'cluster': c.name,
                'server': c.server,
                'status': c.connectionState.status
              }
            }).toJSON()
          : [].toJSON()
    {{- end }}
{{- end }}
