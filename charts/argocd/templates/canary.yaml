{{- if and .Values.canary.enabled (or .Values.canary.repositories.enabled .Values.canary.clusters.enabled) }}
{{- $baseURL := trimSuffix "/" (required "argocd.baseURL is required when canary.enabled=true" .Values.argocd.baseURL) }}
apiVersion: canaries.flanksource.com/v1
kind: Canary
metadata:
  name: {{ printf "%s-health" (include "argocd.fullname" .) | trunc 63 | trimSuffix "-" }}
  labels:
    {{- include "argocd.labels" . | nindent 4 }}
spec:
  schedule: {{ .Values.canary.schedule | quote }}
  http:
    {{- if .Values.canary.repositories.enabled }}
    - name: argocd-repositories
      {{- if .Values.argocd.connection }}
      connection: {{ .Values.argocd.connection | quote }}
      {{- end }}
      url: {{ printf "%s/api/v1/repositories?forceRefresh=true" $baseURL }}
      headers:
        - name: Authorization
          {{- if .Values.argocd.token.valueFrom }}
          valueFrom:
            {{- .Values.argocd.token.valueFrom | toYaml | nindent 12 }}
          {{- else }}
          value: {{ .Values.argocd.token.value | quote }}
          {{- end }}
      responseCodes: [200]
      transformDeleteStrategy: OnTransformMarkHealthy
      transform:
        expr: |
          has(json.items) && json.items != null ?
            json.items.map(r, {
              'name': 'argocd-repo/' + r.repo,
              'icon': 'git',
              'pass': r.connectionState.status == 'Successful',
              'message': r.connectionState.status == 'Successful'
                ? r.repo + ' is healthy'
                : r.repo + ' connection failed: ' + (has(r.connectionState.message) ? r.connectionState.message : 'unknown error'),
              'labels': {
                'repo': r.repo,
                'status': r.connectionState.status
              }
            }).toJSON()
          : [].toJSON()
    {{- end }}

    {{- if .Values.canary.clusters.enabled }}
    - name: argocd-clusters
      {{- if .Values.argocd.connection }}
      connection: {{ .Values.argocd.connection | quote }}
      {{- end }}
      url: {{ printf "%s/api/v1/clusters" $baseURL }}
      headers:
        - name: Authorization
          {{- if .Values.argocd.token.valueFrom }}
          valueFrom:
            {{- .Values.argocd.token.valueFrom | toYaml | nindent 12 }}
          {{- else }}
          value: {{ .Values.argocd.token.value | quote }}
          {{- end }}
      responseCodes: [200]
      transformDeleteStrategy: OnTransformMarkHealthy
      transform:
        expr: |
          has(json.items) && json.items != null ?
            json.items.map(c, {
              'name': 'argocd-cluster/' + c.name,
              'icon': 'kubernetes',
              'pass': c.connectionState.status == 'Successful',
              'message': c.connectionState.status == 'Successful'
                ? c.name + ' (' + c.server + ') is healthy'
                : c.name + ' (' + c.server + ') connection failed: ' + (has(c.connectionState.message) ? c.connectionState.message : 'unknown error'),
              'labels': {
                'cluster': c.name,
                'server': c.server,
                'status': c.connectionState.status
              }
            }).toJSON()
          : [].toJSON()
    {{- end }}
{{- end }}
{{- if and .Values.canary.enabled .Values.canary.deployment.enabled .Values.canary.deployment.resources }}
{{- $deployment := .Values.canary.deployment }}
---
apiVersion: canaries.flanksource.com/v1
kind: Canary
metadata:
  name: {{ printf "%s-deployment" (include "argocd.fullname" .) | trunc 63 | trimSuffix "-" }}
  labels:
    {{- include "argocd.labels" . | nindent 4 }}
spec:
  schedule: {{ $deployment.schedule | quote }}
  kubernetesResource:
    - name: argocd-deployment
      description: Verify ArgoCD can deploy resources end-to-end
      clearResources: true
      resources:
        {{- $deployment.resources | toYaml | nindent 8 }}
      waitFor:
        timeout: {{ $deployment.waitTimeout }}
        expr: |
          dyn(resources).all(r, k8s.isReady(r))
        delete: true
{{- end }}
