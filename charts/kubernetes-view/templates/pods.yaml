{{- if and .Values.views.enabled .Values.views.pods.enabled .Values.global.prometheus.connection }}
apiVersion: mission-control.flanksource.com/v1
kind: View
metadata:
  name: pods-{{ .Values.clusterName }}
  labels:
    {{- include "kubernetes-view.labels" . | nindent 4 }}
spec:
  display:
    title: Pods
    icon: pod
    {{- if .Values.views.pods.sidebar }}
    sidebar: true
    {{- end }}
  columns:
    - description: The pod name.
      name: name
      type: string
      primaryKey: true
    - description: The namespace name.
      name: namespace
      type: string
      primaryKey: true
    - description: The status of the pod.
      name: status
      type: status
    - description: The health of the pod.
      name: health
      type: health
    - description: The memory usage of the pod.
      name: memory
      type: string
    - description: The last updated time.
      name: created
      type: datetime
  merge: |
    SELECT 
      pod.name,
      json_extract(pod.tags, '$.namespace') AS namespace,
      pod.status,
      pod.health,
      pod.created_at,
      COALESCE(CAST(metrics.value AS TEXT), '0') || '/' || 
      COALESCE(
        json_extract(pod.config, '$.spec.containers[0].resources.limits.memory'), 
        ''
      ) AS memory
    FROM pod
    LEFT JOIN metrics 
      ON pod.name = metrics.pod 
      AND json_extract(pod.tags, '$.namespace') = metrics.namespace
  queries:
    metrics:
      prometheus:
        connection: {{ .Values.global.prometheus.connection }}
        query: |
          sum by (namespace, pod) (
            container_memory_working_set_bytes{
              container!="POD", # Skip The pause/infra container
              image!="" # Skip dead containers
            }
          ) / 1024 / 1024
    pod:
      configs:
        tagSelector: "cluster={{ .Values.clusterName }}"
        types:
          - Kubernetes::Pod
  mapping:
    created: row.created_at
{{- end }}