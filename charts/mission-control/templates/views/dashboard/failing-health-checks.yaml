# yaml-language-server: $schema=https://raw.githubusercontent.com/flanksource/duty/main/schema/openapi/view.schema.json
{{- if and .Values.views.enabled .Values.views.failingHealthChecks.enabled}}
apiVersion: mission-control.flanksource.com/v1
kind: View
metadata:
  name: failing-health-checks
  labels:
    {{- include "mission-control.labels" . | nindent 4 }}
spec:
  display:
    title: Failing Health Checks
    icon: health
    {{- if .Values.views.failingHealthChecks.sidebar }}
    sidebar: true
    {{- end }}
  cache:
    maxAge: 5m
    minAge: 10s
  columns:
    - name: id
      type: string
      primaryKey: true
      hidden: true
    - name: name
      type: string
    - name: namespace
      type: string
    - name: type
      type: string
    - name: status
      type: status
    - name: severity
      type: string
    - name: last_transition_time
      type: datetime
    - name: description
      type: string
  queries:
    failing_checks:
      columns:
        id: string
        name: string
        namespace: string
        type: string
        status: string
        severity: string
        last_transition_time: datetime
        description: string
      sql:
        connection: "connection://{{.Release.Namespace}}/{{ .Values.connectionName }}"
        query: |
          SELECT
            id,
            name,
            namespace,
            type,
            status,
            severity,
            last_transition_time,
            description
          FROM checks
          WHERE deleted_at IS NULL
            AND status <> 'healthy'
          ORDER BY COALESCE(last_transition_time, created_at) DESC
{{- end}}
