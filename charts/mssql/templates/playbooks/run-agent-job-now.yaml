{{- if and .Values.playbooks.enabled .Values.playbooks.runAgentJob }}
apiVersion: mission-control.flanksource.com/v1
kind: Playbook
metadata:
  name: run-agent-job-now
spec:
  title: Run Agent Job Now
  icon: mssql
  description: Execute T-SQL steps from an Agent Job immediately
  configs:
    - types:
        - MSSQL::AgentJob
  {{ include "mssql.approvers" . | indent 2 | trim }}
  actions:

    - name: Execute T-SQL Steps
      sql:
        {{ include "mssql.connection-playbook" . }}
        driver: mssql
        query: "$(.config.config.sql)"
{{- end }}
