{{- if and .Values.views.enabled .Values.views.deployments.enabled }}
apiVersion: mission-control.flanksource.com/v1
kind: View
metadata:
  name: deployments
  labels:
    {{- include "kubernetes-view.labels" . | nindent 4 }}
spec:
  display:
    title: Helm Releases
    icon: rocket
    {{- if .Values.views.deployments.sidebar }}
    sidebar: true
    {{- end }}
  panels:
    - name: Health
      description: Helm Releases grouped by health
      type: piechart
      piechart:
        showLabels: true
        colors:
          healthy: "#28C19B"
          unhealthy: "#F04E6E"
          unknown: "#666666"
          warning: "#F4B23C"
      query: SELECT COUNT(*) AS count, health FROM helm_releases GROUP BY health
    - name: Status
      description: Helm Releases grouped by status
      type: piechart
      piechart:
        colors:
          InstallSucceeded: "#28C19B"
          RollbackSucceeded: "#F4B23C"
          UpgradeFailed: "#F04E6E"
          UpgradeSucceeded: "#5965F2"
          Reconciling: "#666666"
      query: SELECT COUNT(*) AS count, status FROM helm_releases GROUP BY status
  columns:
    - name: id
      type: string
      description: The id of the deployment.
      primaryKey: true
      hidden: true
    - name: application
      type: string
      description: The application name.
      url:
        config: row.id
    - name: namespace
      type: string
      description: The namespace name.
      filter:
        type: multiselect
      url:
        config: f("name=$(tags.namespace) tags.cluster=$(tags.cluster) type=Kubernetes::Namespace", row)
    - name: chart
      type: string
      description: The chart name.
    - name: version
      type: string
      description: The version of the deployment.
    - name: status
      type: status
      description: The status of the deployment.
      filter:
        type: multiselect
    - name: health
      type: health
      description: The health of the deployment.
      filter:
        type: multiselect
    - name: lastUpdated
      type: datetime
      description: The last updated time.
  queries:
    helm_releases:
      configs:
        tagSelector: "cluster={{ .Values.clusterName }}"
        agent: "all"
        types:
          - Kubernetes::HelmRelease
  mapping:
    application: row.name
    namespace: row.tags.namespace
    chart: row.config.status.history[0].chartName
    version: row.config.status.history[0].chartVersion
    lastUpdated: row.updated_at
{{- end }}